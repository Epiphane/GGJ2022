---
id: c1ivy
name: Game Update and Render Loop
file_version: 1.0.2
app_version: 0.7.2-0
file_blobs:
  lib/juicy.ts: 7605e86817fad3f8f7ce0123a66ada55891a9fb3
---

# Update

<br/>

The beating heart of JuicyJS: the update loop.

Note that this is the `update`[<sup id="1SOuF">â†“</sup>](#f-1SOuF) function of the **Game** object, not the **State** object.

`requestAnimationFrame`[<sup id="1MhkTY">â†“</sup>](#f-1MhkTY) queues up whatever function you ask it to. That function will run the next frame of the browser (i.e. 60 times a second on a 60fps monitor).

It's a common pattern (as we do here) to queue up _yourself._ The result is that `update`[<sup id="ZEtqE3">â†“</sup>](#f-ZEtqE3) is called once every frame.

Note that we use an arrow function, `updateFn`[<sup id="Z1psUhN">â†“</sup>](#f-Z1psUhN) , in order to make sure that `this` isn't set to `window` on the next update cycle, because JavaScript is weird like that.
<!-- NOTE-swimm-snippet: the lines below link your snippet to Swimm -->
### ðŸ“„ lib/juicy.ts
```typescript
â¬œ 311            return this; // Enable chaining
â¬œ 312        }
â¬œ 313    
ðŸŸ© 314        private updateFn = () => this.update();
ðŸŸ© 315    
ðŸŸ© 316        update() {
ðŸŸ© 317            if (!this.running) {
ðŸŸ© 318                return;
ðŸŸ© 319            }
ðŸŸ© 320    
ðŸŸ© 321            requestAnimationFrame(this.updateFn);
â¬œ 322            const nextTime = new Date().getTime();
â¬œ 323    
â¬œ 324            if (this.debug && nextTime !== this.lastTime) {
```

<br/>

This is where we call the state's update function, and sometimes render.

If more than ~0.2 seconds have elapsed, it's likely that the browser is lagging a lot or the user tabbed off and came back. In those cases, don't run the update because it might make a lot of weird physics stuff happen.

The state signals that something has changed + is worth rendering by returning `true` from its `update`[<sup id="ZmRAaO">â†“</sup>](#f-ZmRAaO) function, or by setting its`updated`[<sup id="ZCNo2Y">â†“</sup>](#f-ZCNo2Y) field to true (for instance, if a sprite finishes loading in, we set `updated`[<sup id="ZCNo2Y">â†“</sup>](#f-ZCNo2Y) to true, because that could happen at any async time).

If the state has updated, or if it hasn't rendered yet, render it.
<!-- NOTE-swimm-snippet: the lines below link your snippet to Swimm -->
### ðŸ“„ lib/juicy.ts
```typescript
â¬œ 328                this.debug.innerHTML = 'FPS: ' + Math.floor(this.fps);
â¬œ 329            }
â¬œ 330    
ðŸŸ© 331            const dt = this.timeStep ? this.timeStep : this.timeScale * (nextTime - this.lastTime) / 1000;
ðŸŸ© 332            this.timeStep = undefined;
ðŸŸ© 333            if (dt > 0.2) {
ðŸŸ© 334                this.lastTime = nextTime;
ðŸŸ© 335                return;
ðŸŸ© 336            }
ðŸŸ© 337    
ðŸŸ© 338            try {
ðŸŸ© 339                this.time += dt;
ðŸŸ© 340                const updated = !this.state.update(dt) || this.state.updated;
ðŸŸ© 341                this.state.updated = false;
ðŸŸ© 342    
ðŸŸ© 343                this.lastTime = nextTime;
ðŸŸ© 344    
ðŸŸ© 345                if (updated || !this.state.hasRendered) {
ðŸŸ© 346                    this.render();
ðŸŸ© 347                    this.state.hasRendered = true;
ðŸŸ© 348                }
ðŸŸ© 349            }
â¬œ 350            catch (e) {
â¬œ 351                console.error(e);
â¬œ 352                this.pause();
```

<br/>

# Render

<br/>

Only called from update, as above.

We `save`[<sup id="lMsts">â†“</sup>](#f-lMsts) and `restore`[<sup id="1UpIFe">â†“</sup>](#f-1UpIFe) the context, so don't worry about messing with the context in `state.render`[<sup id="1KRpin">â†“</sup>](#f-1KRpin). Go nuts!

Unless the state asks us not to, we wipe the whole canvas every frame before rendering to it again.
<!-- NOTE-swimm-snippet: the lines below link your snippet to Swimm -->
### ðŸ“„ lib/juicy.ts
```typescript
â¬œ 353            }
â¬œ 354        }
â¬œ 355    
ðŸŸ© 356        render() {
ðŸŸ© 357            const { context, canvas } = this;
ðŸŸ© 358            if (!context || !canvas) {
ðŸŸ© 359                this.running = false;
ðŸŸ© 360                throw Error('Game was not properly initialized - canvas is unavailable');
ðŸŸ© 361            }
ðŸŸ© 362    
ðŸŸ© 363            context.save();
ðŸŸ© 364            if (!this.state.stopClear) {
ðŸŸ© 365                context.fillStyle = this.state.clearColor ?? this.clearColor;
ðŸŸ© 366                context.fillRect(0, 0, this.size.x, this.size.y);
ðŸŸ© 367            }
ðŸŸ© 368    
ðŸŸ© 369            this.state.render(context);
ðŸŸ© 370            context.restore();
â¬œ 371    
â¬œ 372            this.afterRenderCallbacks.forEach(callback => callback(canvas));
â¬œ 373    
```

<br/>

<!-- THIS IS AN AUTOGENERATED SECTION. DO NOT EDIT THIS SECTION DIRECTLY -->
### Swimm Note

<span id="f-1MhkTY">requestAnimationFrame</span>[^](#1MhkTY) - "lib/juicy.ts" L321
```typescript
        requestAnimationFrame(this.updateFn);
```

<span id="f-1UpIFe">restore</span>[^](#1UpIFe) - "lib/juicy.ts" L370
```typescript
        context.restore();
```

<span id="f-lMsts">save</span>[^](#lMsts) - "lib/juicy.ts" L363
```typescript
        context.save();
```

<span id="f-1KRpin">state.render</span>[^](#1KRpin) - "lib/juicy.ts" L369
```typescript
        this.state.render(context);
```

<span id="f-ZmRAaO">update</span>[^](#ZmRAaO) - "lib/juicy.ts" L340
```typescript
            const updated = !this.state.update(dt) || this.state.updated;
```

<span id="f-1SOuF">update</span>[^](#1SOuF) - "lib/juicy.ts" L314
```typescript
    private updateFn = () => this.update();
```

<span id="f-ZEtqE3">update</span>[^](#ZEtqE3) - "lib/juicy.ts" L316
```typescript
    update() {
```

<span id="f-ZCNo2Y">updated</span>[^](#ZCNo2Y) - "lib/juicy.ts" L340
```typescript
            const updated = !this.state.update(dt) || this.state.updated;
```

<span id="f-Z1psUhN">updateFn</span>[^](#Z1psUhN) - "lib/juicy.ts" L314
```typescript
    private updateFn = () => this.update();
```

<br/>

This file was generated by Swimm. [Click here to view it in the app](https://app.swimm.io/repos/Z2l0aHViJTNBJTNBR0dKMjAyMiUzQSUzQUVwaXBoYW5l/docs/c1ivy).